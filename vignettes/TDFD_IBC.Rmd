---
title: "Tutorial for analysis of taxonomic and functional diversdity in relation to metal contamination"
author: "Benjamin Alric"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{color, fancyvrb}
output:
  rmdformats::readthedown:
    highlight: tango
    number_section: yes
    css: custom.css
---


```{r setup, include=FALSE}
# Global options
options(max.print="75")
knitr::opts_chunk$set(echo=TRUE,
               eval=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
knitr::opts_knit$set(width=75)
```

# Aims
In this repository, you will find the tutotrial reporting the code to reproduce the analyses and figures carried out in Alric *et al.* (2021). The scope of this tutorial is to increase its reproducibility, clarity, transparency and dissemination. Data analysis was done using R version 3.6.3. This documatn was compiled with the *rmarkdown* package version 2.8. This tutorial is licensed under CC BY-NC-ND 4.0, which means you are free to share, copy and redistribute this tutorial in any medium or format under the terms of attribution of appropriate credit, non-commercial purposes and no derivatives. The citation is:

> Alric B., O. Geffard, A. chaumot. Sepcies replacement associated with loawer richness but unchaged functional diversity of invertebrate communities in metal-contaminated streams.

# Software preparation
Install R ([https://www.r-project.org]) (R Core Team 2020) if you do not have it already.
Then, install and load the following packages.

```{r, eval = TRUE}
library(ade4)
library(ape)
library(FD)
library(funrar)
library(vegan)
library(quantreg)
library(rgdal)
library(GISTools)
library(ggplot2)
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggforce)
library(grid)
library(tibble)
library(sf)
library(ggspatial)
library(patchwork)
library(dendextend)
library(cowplot)
library(BAT)
library(adiv)
```

# Load functions
Load functions at the following link:
```{r, eval = FALSE}
setwd("C:/Users/benjamin/Documents/TDFD_IBCmetals/functions") # CHANGE ME to where you want functions' file to be load
source("TDFD_IBC_functions.R")
```

# Data import
Download data at the following link:
```{r, eval = FALSE}
setwd("C:/Users/benjamin/Documents/TDFD_IBCmetals/data") # CHANGE ME to where you want data's file to be load
load("TDFD_IBC_data.RData")
```

# Selection of Eltonian traits
```{r, eval = FALSE}
trait_eltonian <- TDFD_IBC_data$trait
trait_eltonian$fresh.water <- trait_eltonian$brackish.water <- 
  trait_eltonian$river.channel <- trait_eltonian$banks..connected.side.arms <-
  trait_eltonian$ponds..pools..disconnected.side.arms <- trait_eltonian$marshes..peat.bogs <-
  trait_eltonian$temporary.waters <- trait_eltonian$lakes <- trait_eltonian$groundwaters <-
  trait_eltonian$crenon <- trait_eltonian$epirithron <- trait_eltonian$metarithron <- 
  trait_eltonian$hyporithron <- trait_eltonian$epipotamon <- trait_eltonian$metapotamon <- 
  trait_eltonian$estuary <- trait_eltonian$outside.river.system <- trait_eltonian$lowlands <- 
  trait_eltonian$piedmont.level <- trait_eltonian$alpine.level <- trait_eltonian$flags.boulders.cobbles.pebbles <- 
  trait_eltonian$gravel <- trait_eltonian$sand <- trait_eltonian$silt <- trait_eltonian$macrophytes <- 
  trait_eltonian$microphytes <- trait_eltonian$twigs.roots <- trait_eltonian$organic.detritus.litter <-
  trait_eltonian$mud <- trait_eltonian$null <- trait_eltonian$slow <- trait_eltonian$medium <- 
  trait_eltonian$fast <- trait_eltonian$oligotrophic <- trait_eltonian$mesotrophic <- trait_eltonian$eutrophic <-
  trait_eltonian$psychrophilic <- trait_eltonian$thermophilic <- trait_eltonian$eurythermic <-
  trait_eltonian$xenosaprobic <- trait_eltonian$oligosaprobic <- trait_eltonian$b.mesosaprobic <- 
  trait_eltonian$a.mesosaprobic <- trait_eltonian$polysaprobic <- trait_eltonian$X..4 <- trait_eltonian$X..4.4.5 <- 
  trait_eltonian$X..4.5.5 <- trait_eltonian$X..5.5.5 <- trait_eltonian$X..5.5.6 <- trait_eltonian$X..6 <- NULL

blo_eltonian <- c(7, 2, 3, 4, 7, 4, 5, 4, 8, 9, 7) # nombre de modalites par traits
names(blo_eltonian) <- c("Maximal potential size",
                         "Life-cycle duration",
                         "Reproductive cycles per year",
                         "Aquatic stages",
                         "Reproduction",
                         "Dispersal",
                         "Resistance forms",
                         "Respiration",
                         "Locomotion type",
                         "Food",
                         "Feeding type")
trait_eltonian <- prep.fuzzy.var(trait_eltonian, col.blocks = blo_eltonian)
# Scale table of species_x_trait
z.trait <- scale(trait_eltonian, center = TRUE, scale = TRUE)
# Distance matrix from scaled table species_x_trait
e.dist <- vegdist(z.trait, method = "euclidean")
```

# Computation of taxonomic richness
```{r, eval = FALSE}
TR <- rowSums(apply(TDFD_IBC_data$abundance[ ,-c(1:8)], c(1,2), function(x){ifelse(x != 0, 1, 0)}))
```

# Computation of taxonomic diveristy
```{r, eval = FALSE}
H <- diversity(TDFD_IBC_data$abundance[, -c(1:8)]) # Shannon entropy (base e)
Hb2 <- diversity(TDFD_IBC_data$abundance[, -c(1:8)], base = 2) # Shannon entropy (base 2)
N1 <- exp(H) # Shannon diversity (base e)
N1b2 <- 2 ^ Hb2 # Shannon diversity (base 2)
```

# Computation of functional diversity
| <span> |
| :------------------------------------------------------------------------------------------------------------ |
| **NOTE:** Rao's index is computed according to Champely & Chessel [*Env.Ecol.Stat.* **9**, 167-177 (2002)]|
| <span> |
```{r, eval = FALSE}
RaoQ.CH.scale <- Rao.CH(TDFD_IBC_data$abundance[, -c(1:8)], z.trait, method = "euclidean", scale = TRUE)
colnames(RaoQ.CH.scale) <- "RaoQ.CH.scale"
```


| <span> |
| :------------------------------------------------------------------------------------------------------------ |
| **NOTE:** Functional dispersion is computed accroding to Laliberte & Legendre [*Ecology* **91**, 299-305 (2010)]|
| <span> |
```{r, eval = FALSE}
FD <- dbFD(z.trait, TDFD_IBC_data$abundance[, -c(1:8)], w.abun = TRUE, corr = "sqrt", calc.FRic = TRUE, m = 10, 
           stand.FRic = TRUE, scale.RaoQ = FALSE, calc.FGR = FALSE,
           calc.CWM = FALSE, print.pco = FALSE)
```

# Decomposition and test of beta taxonomic diversity
```{r, eval = FALSE}
G13 <- setNames(list(as.character(TDFD_IBC_data$abundance$cd_site[TDFD_IBC_data$abundance$group == "UnCont1" | TDFD_IBC_data$abundance$group == "Cont"])), "G13")
betaIBC.BR.FF <- betadiv(taxa = TDFD_IBC_data$abundance[, -c(2:8)], site = G13, method = "BR", nrepet = 9999)
betaIBC.SOR.FF <- betadiv(taxa = TDFD_IBC_data$abundance[, -c(2:8)], site = G13, method = "SOR", nrepet = 9999)
```

# Computation of scarcity at local scale
```{r, eval = FALSE}
abun_subg <- TDFD_IBC_data$abundance[!(TDFD_IBC_data$abundance$group  == "Intermed" | TDFD_IBC_data$abundance$group == "UnCont2"), ]
abun_subg.1 <- as.matrix(abun_subg[, -c(1:8)])
rownames(abun_subg.1) <- abun_subg$cd_opecont
abun_subg.1 <- abun_subg.1[, !(colSums(abun_subg.1) == 0)]
abun_subg.relative <- sweep(abun_subg.1, 1, rowSums(abun_subg.1), "/")
abun_subg_tidy <- matrix_to_stack(abun_subg.relative, "value", "site", "species")
abun_subg_tidy <- abun_subg_tidy[which(abun_subg_tidy$value > 0), ]
abun_subg_tidy$site <- as.character(abun_subg_tidy$site)
abun_subg_tidy$species <- as.character(abun_subg_tidy$species)
Si.tidy <- scarcity_stack(com_df = abun_subg_tidy,
                          sp_col = "species",
                          com = "site",
                          abund = "value")
```

# Computation of functional contribution and originality of each species to the total volume of the trait space 
## Data preparation
```{r, eval = FALSE}
# Create name vector for taxa either specifc to UnCont1 and Cont or commun to both
taxa_G1 <- c("Euleuctra", "Perla", "Silo", "Cheumatopsyche", "Lepidostoma", "Limnephilinae" , "Odontocerum", "Polycentropus",
             "Rhyacophila", "Sericostoma", "Ecdyonurus", "Habroleptoides", "Habrophlebia", "Aphelocheirus", "Normandia",
             "Riolus", "Limoniidae", "Sisyra", "Orconectes", "Bithynia", "Radix", "Theodoxus")
taxa_G3 <- c("Protonemura", "Ecnomus", "Goera", "Hydroptila", "Oecetis", "Psychomyia", "Leptophlebiidae", 
             "Micronecta", "Stenelmis", "Empididae",  "Tabanidae", "Onychogomphus", "Physella")
taxa_common <- c("Gammarus", "Chironomidae", "Corbicula", "Asellidae", "Echinogammarus", "Baetis",
                 "Elmis", "Hydropsyche", "Esolus", "Caenis", "Athericidae", "Ancylus", "Ithytrichia",
                 "Simuliidae", "Limnius", "Potamopyrgus", "Physa", "Calopteryx", "Ephemera", "Ephemerella",
                 "Pisidium", "Oulimnius", "Heptagenia", "Procloeon", "Leuctra", "Platycnemis", "Pomatinus", "Brachycentrus")

# Abundance tables to estimate the contribution of each species to the trait space occupied by the community 
comm_UnCont1_contrib <- TDFD_IBC_data$abundance[TDFD_IBC_data$abundance$group == "UnCont1" , colnames(TDFD_IBC_data$abundance) %in% taxa_G1 | colnames(TDFD_IBC_data$abundance) %in% taxa_common]
comm_Cont_contrib <- TDFD_IBC_data$abundance[TDFD_IBC_data$abundance$group == "Cont", colnames(TDFD_IBC_data$abundance) %in% taxa_G3 | colnames(TDFD_IBC_data$abundance) %in% taxa_common]

# Abundance tables to estimate the beta functional diversity
comm_UnCont1_Eq <- TDFD_IBC_data$abundance[TDFD_IBC_data$abundance$group == "UnCont1", colnames(TDFD_IBC_data$abundance) %in% taxa_G1]
comm_Cont_Eq <- TDFD_IBC_data$abundance[TDFD_IBC_data$abundance$group == "Cont", colnames(TDFD_IBC_data$abundance) %in% taxa_G3]
comm_UnCont1_Cont_Eq <- TDFD_IBC_data$abundance[TDFD_IBC_data$abundance$group == "UnCont1" | TDFD_IBC_data$abundance$group == "Cont", colnames(TDFD_IBC_data$abundance) %in% taxa_G1 | colnames(TDFD_IBC_data$abundance) %in% taxa_G3]
comm_UnCont1_Cont_Eq <- comm_UnCont1_Cont_Eq[, colSums(comm_UnCont1_Cont_Eq) != 0]

# Trait tables for contribution analysis
trait_UnCont1_contrib <- TDFD_IBC_data$trait[rownames(TDFD_IBC_data$trait) %in% colnames(comm_UnCont1_contrib), ]
trait_Cont_contrib <- TDFD_IBC_data$trait[rownames(TDFD_IBC_data$trait) %in% colnames(comm_Cont_contrib), ]

# Trait tables for beta diversity analysis
trait_UnCont1_Eq <- TDFD_IBC_data$trait[rownames(TDFD_IBC_data$trait) %in% colnames(comm_UnCont1_Eq), ]
trait_Cont_Eq <- TDFD_IBC_data$trait[rownames(TDFD_IBC_data$trait) %in% colnames(comm_Cont_Eq), ]
```
| <span> |
| :------------------------------------------------------------------------------------------------------------ |
| **WARNING:** Make the below step four times, one for each combination of group of sites for contribution analysis (two times) and for beta diversity analysis (two times). Change the trait_eltonian object according if you work on UnCont1, Cont or both group of sites. <br/> <br/> Contribution analysis: <br/> When you work with UnCont1 define the *trait_eltonian* object as *trait_UnCont1_contrib*. <br/> When you work with Cont define the *trait_eltonian* object as *trait_Cont_contrib*. <br/> <br/> Beta diversity analysis: <br/> When you work with UnCont1 define the *trait_eltonian* object as *trait_UnCont1_Eq*. <br/> When you work with Cont define the *trait_eltonian* object as *trait_Cont_Eq*.|
| <span> |
```{r, eval = FALSE}
# Select the Eltonian traits
trait_eltonian_Eq <- trait_Cont_Eq # CHANGE ME with the good table

trait_eltonian_Eq$fresh.water <- trait_eltonian_Eq$brackish.water <- 
  trait_eltonian_Eq$river.channel <- trait_eltonian_Eq$banks..connected.side.arms <-
  trait_eltonian_Eq$ponds..pools..disconnected.side.arms <- trait_eltonian_Eq$marshes..peat.bogs <-
  trait_eltonian_Eq$temporary.waters <- trait_eltonian_Eq$lakes <- trait_eltonian_Eq$groundwaters <-
  trait_eltonian_Eq$crenon <- trait_eltonian_Eq$epirithron <- trait_eltonian_Eq$metarithron <- 
  trait_eltonian_Eq$hyporithron <- trait_eltonian_Eq$epipotamon <- trait_eltonian_Eq$metapotamon <- 
  trait_eltonian_Eq$estuary <- trait_eltonian_Eq$outside.river.system <- trait_eltonian_Eq$lowlands <- 
  trait_eltonian_Eq$piedmont.level <- trait_eltonian_Eq$alpine.level <- trait_eltonian_Eq$flags.boulders.cobbles.pebbles <- 
  trait_eltonian_Eq$gravel <- trait_eltonian_Eq$sand <- trait_eltonian_Eq$silt <- trait_eltonian_Eq$macrophytes <- 
  trait_eltonian_Eq$microphytes <- trait_eltonian_Eq$twigs.roots <- trait_eltonian_Eq$organic.detritus.litter <-
  trait_eltonian_Eq$mud <- trait_eltonian_Eq$null <- trait_eltonian_Eq$slow <- trait_eltonian_Eq$medium <- 
  trait_eltonian_Eq$fast <- trait_eltonian_Eq$oligotrophic <- trait_eltonian_Eq$mesotrophic <- trait_eltonian_Eq$eutrophic <-
  trait_eltonian_Eq$psychrophilic <- trait_eltonian_Eq$thermophilic <- trait_eltonian_Eq$eurythermic <-
  trait_eltonian_Eq$xenosaprobic <- trait_eltonian_Eq$oligosaprobic <- trait_eltonian_Eq$b.mesosaprobic <- 
  trait_eltonian_Eq$a.mesosaprobic <- trait_eltonian_Eq$polysaprobic <- trait_eltonian_Eq$X..4 <- trait_eltonian_Eq$X..4.4.5 <- 
  trait_eltonian_Eq$X..4.5.5 <- trait_eltonian_Eq$X..5.5.5 <- trait_eltonian_Eq$X..5.5.6 <- trait_eltonian_Eq$X..6 <- NULL

blo_eltonian <- c(7, 2, 3, 4, 7, 4, 5, 4, 8, 9, 7) # number of modalities per traits
names(blo_eltonian) <- c("Maximal potential size",
                         "Life-cycle duration",
                         "Reproductive cycles per year",
                         "Aquatic stages",
                         "Reproduction",
                         "Dispersal",
                         "Resistance forms",
                         "Respiration",
                         "Locomotion type",
                         "Food",
                         "Feeding type")
trait_eltonian_Eq <- prep.fuzzy.var(trait_eltonian_Eq, col.blocks = blo_eltonian)

z.trait_UnCont1_contrib <- scale(trait_eltonian, center = TRUE, scale = TRUE)
z.trait_Cont_contrib <- scale(trait_eltonian, center = TRUE, scale = TRUE)
z.trait_UnCont1_Eq <- scale(trait_eltonian, center = TRUE, scale = TRUE)
z.trait_Cont_Eq <- scale(trait_eltonian, center = TRUE, scale = TRUE)
````

## Decomposition of functional beta diversity
| <span> |
| :------------------------------------------------------------------------------------------------------------ |
| **NOTE:** Decomposition according to the framework proposed by Pavoine et al. [*Meth.Ecol.Evol.* **7**, 1152-1163 (2016)]|
| <span> |
```{r, eval = FALSE}
# Converting traits in a distance matrix (euclidean distance)
e.dist_UnCont1_Eq <- vegdist(z.trait_UnCont1_Eq, method = "euclidean", na.rm = TRUE)
e.dist_Cont_Eq <- vegdist(z.trait_Cont_Eq, method = "euclidean", na.rm = TRUE)

# Apportionment of diversity according to the third approach of Pavoine et al (Meth.Ecol.Evol. 2016)
EqRao_eq_UnCont1 <- EqRao(comm = comm_UnCont1_Eq, dis = e.dist_UnCont1_Eq, , formula = "EDI", option = "eq")
EqRao_normed1_UnCont1 <- EqRao(comm_UnCont1_Eq, e.dist_UnCont1_Eq, , formula = "EDI", option = "normed1")
EqRao_normed2_UnCont1 <- EqRao(comm_UnCont1_Eq, e.dist_UnCont1_Eq, , formula = "EDI", option = "normed2")
EqRao_eq_Cont <- EqRao(comm_Cont_Eq, e.dist_Cont_Eq, , formula = "EDI", option = "eq")
EqRao_normed1_Cont <- EqRao(comm_Cont_Eq, e.dist_Cont_Eq, , formula = "EDI", option = "normed1")
EqRao_normed2_Cont <- EqRao(comm_Cont_Eq, e.dist_Cont_Eq, , formula = "EDI", option = "normed2")

# Table of the estimation of beta functional diversity
EqRao_res <- as.data.frame(matrix(0, nrow = 6, ncol = 3))
colnames(EqRao_res) <- c("group_site", "normalization", "beta")
EqRao_res$group_site <- c(rep("UnCont1", 3), rep("Cont", 3))
EqRao_res$normalization <- rep(c("eq", "normed1", "normed2"), 2)
EqRao_res$beta <- c(EqRao_eq_UnCont1$`Equivalent numbers`[1], 
                    EqRao_normed1_UnCont1$`Normed contributions to diversity`,
                    EqRao_normed2_UnCont1$`Normed contributions to diversity`,
                    EqRao_eq_Cont$`Equivalent numbers`[1],
                    EqRao_normed1_Cont$`Normed contributions to diversity`,
                    EqRao_normed2_Cont$`Normed contributions to diversity`)

# Converting traits to a distance matrix (euclidean distance) and transforming them with a PCoA
# Step nedd to compute the contribution, originality and evenness of each species to the trait space occupied by their community
e.dist_UnCont1_contrib <- vegdist(z.trait_UnCont1_contrib, method = "euclidean", na.rm = TRUE)
e.dist_Cont_contrib <- vegdist(z.trait_Cont_contrib, method = "euclidean", na.rm = TRUE)
pcoa_UnCont1_contrib <- pcoa(e.dist_UnCont1_contrib, correction = "cailliez")
pcoa_Cont_contrib <- pcoa(e.dist_Cont_contrib, correction = "cailliez")

# hierachical clustering form the output of each PCoA
tree_UnCont1_contrib <- hclust(dist(pcoa_UnCont1_contrib$vectors[, c(1, 2)]), method = "ward.D2")
tree_Cont_contrib <- hclust(dist(pcoa_Cont_contrib$vectors[, c(1, 2)]), method = "ward.D2")

# Computing the contribution of each species to the trait space occupied by their community
contrib_UnCont1 <- contribution(comm_UnCont1_contrib, tree_UnCont1_contrib, abun = TRUE, relative = TRUE)
rownames(contrib_UnCont1) <- rownames(comm_UnCont1_contrib)
colnames(contrib_UnCont1) <- colnames(comm_UnCont1_contrib)

contrib_Cont <- contribution(comm_Cont_contrib, tree_Cont_contrib, abun = TRUE, relative = TRUE)
rownames(contrib_Cont) <- rownames(comm_Cont_contrib)
colnames(contrib_Cont) <- colnames(comm_Cont_contrib)

# Contribution of each species
contrib1_UnCont1 <- NULL
for (i in 1:ncol(contrib_UnCont1)) {
  contrib1_UnCont1 <- c(contrib1_UnCont1, mean(contrib_UnCont1[, i] , na.rm = TRUE))
}
contrib1_UnCont1 <- data.frame(taxa = colnames(comm_UnCont1_contrib), contribution = contrib1_UnCont1)

contrib1_Cont <- NULL
for (i in 1:ncol(contrib_Cont)) {
  contrib1_Cont <- c(contrib1_Cont, mean(contrib_Cont[, i] , na.rm = TRUE))
}
contrib1_Cont <- data.frame(taxa = colnames(comm_Cont_contrib), contribution = contrib1_Cont)

# Mean contribution
contrib_mean_UnCont1 <- mean(contrib1_UnCont1$contribution[contrib1_UnCont1$taxa %in% taxa_G1])
contrib_mean_common_UnCont1 <- mean(contrib1_UnCont1$contribution[contrib1_UnCont1$taxa %in% taxa_common])
contrib_mean_UnCont1_perct <- (contrib_mean_UnCont1 * 100) / (contrib_mean_common_UnCont1 + contrib_mean_UnCont1)

contrib_mean_Cont <- mean(contrib1_Cont$contribution[contrib1_Cont$taxa %in% taxa_G3])
contrib_mean_common_Cont <- mean(contrib1_UnCont1$contribution[contrib1_Cont$taxa %in% taxa_common])
contrib_mean_Cont_perct <- (contrib_mean_Cont * 100) / (contrib_mean_common_Cont + contrib_mean_Cont)

# Computing the originality of each species to the trait space occupied by their community
orig_UnCont1 <- BAT::originality(comm_UnCont1_contrib, tree_UnCont1_contrib, abund = TRUE)
rownames(orig_UnCont1) <- rownames(comm_UnCont1_contrib)
colnames(orig_UnCont1) <- colnames(comm_UnCont1_contrib)

orig_Cont <- BAT::originality(comm_Cont_contrib, tree_Cont_contrib, abund = TRUE)
rownames(orig_Cont) <- rownames(comm_Cont_contrib)
colnames(orig_Cont) <- colnames(comm_Cont_contrib)

# Originality of each species
orig1_UnCont1 <- NULL
for (i in 1:ncol(orig_UnCont1)) {
  orig1_UnCont1 <- c(orig1_UnCont1, mean(orig_UnCont1[, i] , na.rm = TRUE))
}
orig1_UnCont1 <- data.frame(taxa = colnames(comm_UnCont1_contrib), orig = orig1_UnCont1)

orig1_Cont <- NULL
for (i in 1:ncol(orig_Cont)) {
  orig1_Cont <- c(orig1_Cont, mean(orig_Cont[, i] , na.rm = TRUE))
}
orig1_Cont <- data.frame(taxa = colnames(comm_Cont_contrib), orig = orig1_Cont)

# Mean originality
orig_mean_UnCont1 <- mean(orig1_UnCont1$orig[orig1_UnCont1$taxa %in% taxa_G1])
orig_mean_common_UnCont1 <- mean(orig1_UnCont1$orig[orig1_UnCont1$taxa %in% taxa_common])
orig_mean_UnCont1_perct <- (orig_mean_UnCont1 * 100) / (orig_mean_common_UnCont1 + orig_mean_UnCont1)

orig_mean_Cont <- mean(orig1_Cont$orig[orig1_Cont$taxa %in% taxa_G3])
orig_mean_common_Cont <- mean(orig1_Cont$orig[orig1_Cont$taxa %in% taxa_common])
orig_mean_Cont_perct <- (orig_mean_Cont * 100) / (orig_mean_common_Cont + orig_mean_Cont)

# Building table with fucntional contribution and funcitonal originality
FD_contrib_orig <- as.data.frame(matrix(0, nrow = 2, ncol = 3))
colnames(FD_contrib_orig) <- c("group_site", "contribution", "originality")
FD_contrib_orig$group_site <- c("UnCont1", "Cont")
FD_contrib_orig$contribution <- c(contrib_mean_UnCont1_perct, contrib_mean_Cont_perct)
FD_contrib_orig$originality <- c(orig_mean_UnCont1_perct, orig_mean_Cont_perct)
```

# Final table with diversity indices to community scale
```{r, eval = FALSE}
TDFD_res <- data.frame(TDFD_IBC_data$abundance[, c(1:8)], TR, Hb2, N1, N1b2, RaoQ.CH.scale, FD$FDis)
TDFD_IBC_res <- list(TDFD_IBC_data$abundance, TDFD_IBC_data$trait, TDFD_IBC_data$info_species, TDFD_res, Si.tidy, EqRao_res, FD_contrib_orig, betaIBC.BR.FF, betaIBC.SOR.FF)
names(TDFD_IBC_res) <- c("abundance", "trait", "info_species", "TDFD_metrics", "scarcity", "EqRao", "FD_contrib_orig", "betadiv_BR", "betadiv_SOR")
save(TDFD_IBC_res, file = "C:/Users/benjamin/Documents/TDFD_IBCmetals/Data/TDFD_IBC_res.RData")
```

# Buiding all figures presented in the mansucript and in the supplementary
## Figure 1
| <span> |
| :------------------------------------------------------------------------------------------------------------ |
| **NOTE:** This figure is composed to 4 panels: <br/>   Panel A: Map of study watershed (Adoure-Garonne) with hydrographic network, sampling sites and insert of the France map <br/r> Panel B: Plot of Shannon diversity along the metal contamination gradient (with quantile regression results) <br/> Panel C: Plot of Rao's index in UnCont1, UnCont2, and Cont group of sites (with anova results|
| <span> |

### Figure 1 - Panel A
```{r, eval = FALSE}
# Set file paths where shape files will be load
pathSHP <- "C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Used_data_AFB48/QGIS_shp_france"

# Load shape files
AG <- readOGR(dsn = paste0(pathSHP, "/contours_adoure_garonne"), layer = "contours_adoure_garonne")
network <- readOGR(dsn = paste0(pathSHP, "/network_AG"), layer = "select_stream")
agence1 <- readOGR(dsn = paste0(pathSHP, "/contours_agences"), layer = "agences_lam93")
agence1@data$color <- c("grey40", "white", "white", "white", "white", "white")

# Rename "X_L93" and "Y_L93" columns in "long" and "lat" to add sampling sites to the map
names(TDFD_IBC_data$abundance)[3:4] <- c("long", 'lat')

# Map of Adoure-Garonne region with hydrographic network
AG_hydro <- ggplot(data = AG, aes(long, lat, group = group)) +
  geom_polygon(fill = 'gray90', color = "black") +
  geom_path(data = network, color = "#99CCFF") + 
  geom_point(data = TDFD_IBC_data$abundance) +
  xlab("Longitude") +
  ylab("Latitude") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12)) +
  labs(tag = "A") +
  ggspatial::annotation_north_arrow(location="tl", height = unit(.75, "cm"),
                                    style = ggspatial::north_arrow_orienteering(text_size = 8),
                                    width = unit(.5, "cm"), pad_y = unit(0.4, "cm")) +
  ggspatial::annotation_scale(location="bl", 
                              pad_x = unit(1, "cm"), text_cex = 0.8, height = unit(0.2, "cm"))

# Map of France with boundaries of six watersheds 
agence2 <- st_as_sf(agence1)
agence3 <- as_tibble(agence2)
map_FR <- ggplot(data = agence3, aes(geometry = geometry)) +
  geom_sf(fill = agence3$color) +
  coord_sf(datum = NA) +
  theme_bw() +
  theme(panel.grid = element_blank())

# Map of Adoure-Garonne region with the France map in insert
Fig1A <- AG_hydro +
  annotation_custom(grob = ggplotGrob(map_FR),
                    xmin = 620000,
                    xmax = 800000,
                    ymin = 6150000,
                    ymax = 6300000)
```

### Figure 1 - Panel B
```{r, eval = FALSE}
# Quantile regression
fit_rq_shannon <- quantreg::rq(N1b2 ~ IBCmetals, data = TDFD_IBC_res$TDFD_metrics, tau = 0.9)
b0 <- summary.rq(fit_rq_shannon, se = "boot", sbmethod = "mcmb")$coefficients["(Intercept)", "Value"] # b = 12.72
b1 <- summary.rq(fit_rq_shannon, se = "boot", sbmethod = "mcmb")$coefficients["IBCmetals", "Value"] # a = -13.97
fit_nlrq_shannon <- quantreg::nlrq(N1b2 ~ exp(a + b * IBCmetals), data = TDFD_IBC_res$TDFD_metrics, 
                                   start = list(a = b0, b = b1), tau = 0.9)
pred_rq_shannon <- predict(fit_rq_shannon)
pred_nlrq_shannon <- predict(fit_nlrq_shannon)
AIC(fit_rq_shannon) # 122.5254
AIC(fit_nlrq_shannon) # 122.6316
predicted_rq_shannon <- data.frame(IBCmetals = TDFD_IBC_res$TDFD_metrics$IBCmetals, pred = pred_rq_shannon)
pv_fit_rq <- summary(fit_rq_shannon, se = "boot")$coefficients["IBCmetals", "Pr(>|t|)"] # p.value = 0.0126

# Plot of the Shannon index against metal contamionation gradient
TDFD_IBC_res$TDFD_metrics$color[TDFD_res$color == "#000000"] <- "#FFFFFF"
par(mar = c(5, 0, 3, 5))
Fig1B <- ggplot(TDFD_res, aes(x = IBCmetals, y = N1b2)) +
  geom_point(shape = 1, size = 4, color = TDFD_IBC_res$TDFD_metrics$color) +
  geom_point(shape = 19, size = 1.5) + 
  geom_line(color = "black", data = predicted_rq_shannon, aes(x = IBCmetals, y = pred)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12)) +
  xlab(expression("IBC"[metals])) +
  ylab("Shannon diversity index") +
  labs(tag = "B") +
  annotate("text", 
           x = 0.28, 
           y = 14.0, 
           label = as.character(expression(paste("y = ", "-13.97", "*", IBC[metals], "+", "12.72"), justify = )),
           parse = TRUE,
           size = 3.5,
           hjust = 0) +
  annotate("text", 
           x = 0.28, 
           y = 13.5, 
           label = as.character(expression(paste(italic(p), "= 0.0126"))),
           parse = TRUE,
           size = 3, 
           hjust = 0)
```

### Figure 1 - Panel C
```{r, eval = FALSE}
# Test the relationship betwwen Rao's index and metal gradient
table_FD <- TDFD_IBC_res$TDFD_metrics[!(TDFD_IBC_res$TDFD_metrics$group == "Intermed"), ]
table_FD$group <- as.factor(table_FD$group)
table_FD$group <- factor(table_FD$group, levels(table_FD$group)[c(3, 4, 1)])

# Test homoscedaticity of variances (levene test)
# if p.value > 0.05 we have homoscedasticity and we can make classical anova [aov()]
# if p.value < 0.05 we have heteroscedasticity and we can make modified anova, i.e. Welch-anova [userfriendlyscience::oneway()]
leven.shan <- car::leveneTest(N1b2 ~ as.factor(group), data = table_FD) # p.value = 0.3595, thus we can made classical anova
leven.Rao.CH.scale <- car::leveneTest(RaoQ.CH.scale ~ as.factor(group), data = table_FD) # p.value = 0.2634, thus we can made classical anova

# Test the group effect on Rao's index
aov.rao <- aov(table_FD$RaoQ.CH.scale ~ table_FD$group)
summary(aov.rao) # p.value = 0.799
aov.rao.posthoc <- TukeyHSD(aov.rao)
table_FD$posthoc.Rao.CH.scale <- "a"

# Table with the mean values of RaoQ's index for each group of sites
mean_RaoQ <- table_FD %>%
  group_by(group) %>%
  summarize(mean_RaoQ.CH.scale = mean(RaoQ.CH.scale)) %>%
  rename(RaoQ.CH.scale = mean_RaoQ.CH.scale)

# Plot Rao's index for UnCont1, UnCont2, and Cont group of sites
Fig1C <- ggplot(table_FD, aes(x = group, y = RaoQ.CH.scale, color = group)) +
  geom_point(data = mean_RaoQ, size = 4, shape = 17, alpha = 0.8, color = "black") +
  geom_point() +
  scale_color_manual(values = c("#0066CC", "#00CC00", "#FF0000")) +
  ylim(c(0, 1)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.position = "none") +
  xlab("") +
  ylab(expression("FD"[Q])) +
  labs(tag = "C") +
  annotate("text",
           x = c(1, 2, 3),
           y = 0.8,
           label = c("a", "a", "a"))
````

### Figure 1 - Panels A-B-C
```{r, eval = FALSE}
# Let's glue the different plots together to build Fig1
design <- c(
  area(1, 1, 1, 1),
  area(2, 1, 3, 1),
  area(4, 1, 4, 1),
  area(1, 2, 2, 2),
  area(3, 2, 4, 2)
)
plot(design)

Fig1 <- plot_spacer() + Fig1A + plot_spacer() + Fig1B + Fig1C +
  plot_layout(design = design, widths = c(0.5, 0.5), heights = c(0.5, 0.5, 0.5))

# Save as tiff file Fig1 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_Fig1.tiff"),
     units = "in", width = 10, height = 8, res = 300)
print(Fig1)
dev.off()
```

![Figure 1](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_Fig1.png)

## Figure 2
```{r, eval = FALSE}
# PCoA on the distance matrix computes from trait table
pcoa0 <- pcoa(e.dist, correction = "cailliez")
hc.pcoa <- hclust(dist(pcoa0$vectors[, c(1, 2)]), method = "ward.D2")
X11()
plot(hc.pcoa, hang = -1)
rect.hclust(hc.pcoa, k = 10)
fac <- cutree(hc.pcoa, k = 10)

# Transform abundance table in tidy format
abun_ibc.tidy <- TDFD_IBC_data$abundance %>% gather(key = "taxa", value = "abun", 9:(ncol(TDFD_IBC_data$abundance)))
abun_ibc.tidy <- abun_ibc.tidy[abun_ibc.tidy$abun !=0, ]
abun_ibc.tidy.G1 <- abun_ibc.tidy[abun_ibc.tidy$group == "UnCont1", ]
abun_ibc.tidy.G3 <- abun_ibc.tidy[abun_ibc.tidy$group == "Cont", ]

# Identify specific taxa to Uncont1 and Cont and common to both
taxa_G1 <- setdiff(unique(abun_ibc.tidy.G1$taxa), unique(abun_ibc.tidy.G3$taxa))
taxa_G3 <- setdiff(unique(abun_ibc.tidy.G3$taxa), unique(abun_ibc.tidy.G1$taxa))
taxa_common <- intersect(unique(abun_ibc.tidy.G1$taxa), unique(abun_ibc.tidy.G3$taxa))

Si_global <- Si.tidy %>%
  mutate(group.site = ifelse(Si.tidy$site %in% TDFD_IBC_data$abundance$cd_opecont[TDFD_IBC_data$abundance$group == "UnCont1"], "UnCont1",
                             ifelse(Si.tidy$site %in% TDFD_IBC_data$abundance$cd_opecont[TDFD_IBC_data$abundance$group == "Cont"], "Cont", NA))) %>%
  mutate(inverse.Si = 1 - Si.tidy$Si) %>%
  group_by(species, group.site) %>%
  summarize(Si = mean(inverse.Si)) %>%
  as.data.frame()

Si_global <-   Si_global %>%
  mutate(group.site.color = ifelse(Si_global$species %in% TDFD_IBC_data$info_species$species[TDFD_IBC_data$info_species$group_site == "UnCont1"], "#6699FF",
                                   ifelse(Si_global$species %in% TDFD_IBC_data$info_species$species[TDFD_IBC_data$info_species$group_site == "Cont"], "#FF6666",
                                          ifelse(Si_global$species %in% TDFD_IBC_data$info_species$species[TDFD_IBC_data$info_species$group_site == "Common"], "#999999", NA)))) %>%
  mutate(occurrence = ifelse(Si_global$species %in% TDFD_IBC_data$info_species$species[TDFD_IBC_data$info_species$group_site == "UnCont1"], "UnCont1",
                             ifelse(Si_global$species %in% TDFD_IBC_data$info_species$species[TDFD_IBC_data$info_species$group_site == "Cont"], "Cont",
                                    ifelse(Si_global$species %in% TDFD_IBC_data$info_species$species[TDFD_IBC_data$info_species$group_site == "Common"], "Common", NA)))) %>%
  arrange(Si) %>%
  as.data.frame()

# Select taxa specific to UnCont1 with value > to 75th percentile
Si.G1 <- Si_global[Si_global$group.site == "UnCont1", ]
Si.G1$species <- factor(Si.G1$species, levels = Si.G1$species)
Si.G1.75perc <- Si.G1[Si.G1$Si >= quantile(Si.G1$Si, probs = seq(0, 1, 0.1))[5], ]

# Select taxa specific to Cont with scarcity > to 75th percentile
Si.G3 <- Si_global[Si_global$group.site == "Cont", ]
Si.G3$species <- factor(Si.G3$species, levels = Si.G3$species)
Si.G3.75perc <- Si.G3[Si.G3$Si >= quantile(Si.G3$Si, probs = seq(0, 1, 0.1))[5], ]

# Identify specific taxa to Uncont1 and Cont and common to both with scarcity > to 75th percentile
taxa.Si.G1 <- setdiff(Si.G1.75perc$species, Si.G3.75perc$species)
taxa.Si.G3 <- setdiff(Si.G3.75perc$species, Si.G1.75perc$species)
taxa.Si.common <- intersect(Si.G3.75perc$species, Si.G1.75perc$species)

# Add informations to the PCoA table need to performe Fig.2
pcoa1 <- data.frame(species = rownames(pcoa0$vectors), pcoa0$vectors[, c(1:2)])
pcoa1 <- pcoa1 %>%
  mutate(clust.color = ifelse(pcoa1$species %in% names(fac[fac == 1]), "#4DAC26",
                              ifelse(pcoa1$species %in% names(fac[fac == 2]), "#BB9D00", 
                                     ifelse(pcoa1$species %in% names(fac[fac == 3]), "#FDB863",
                                            ifelse(pcoa1$species %in% names(fac[fac == 4]), "#D01C8B",
                                                   ifelse(pcoa1$species %in% names(fac[fac == 5]), "#B8E186",
                                                          ifelse(pcoa1$species %in% names(fac[fac == 6]), "#BF812D",
                                                                 ifelse(pcoa1$species %in% names(fac[fac == 7]), "#F1B6DA",
                                                                        ifelse(pcoa1$species %in% names(fac[fac == 8]), "#BABABA",
                                                                               ifelse(pcoa1$species %in% names(fac[fac == 9]), "#404040",
                                                                                      ifelse(pcoa1$species %in% names(fac[fac == 10]), "#FDE725FF", NA))))))))))) %>%
  mutate(clust = ifelse(pcoa1$species %in% names(fac[fac == 1]), "FG5",
                        ifelse(pcoa1$species %in% names(fac[fac == 2]), "FG9", 
                               ifelse(pcoa1$species %in% names(fac[fac == 3]), "FG4",
                                      ifelse(pcoa1$species %in% names(fac[fac == 4]), "FG6",
                                             ifelse(pcoa1$species %in% names(fac[fac == 5]), "FG7",
                                                    ifelse(pcoa1$species %in% names(fac[fac == 6]), "FG10",
                                                           ifelse(pcoa1$species %in% names(fac[fac == 7]), "FG8",
                                                                  ifelse(pcoa1$species %in% names(fac[fac == 8]), "FG3",
                                                                         ifelse(pcoa1$species %in% names(fac[fac == 9]), "FG2",
                                                                                ifelse(pcoa1$species %in% names(fac[fac == 10]), "FG1", NA))))))))))) %>%
  mutate(occurrence = ifelse(pcoa1$species %in% taxa_G1, "UnCont1",
                             ifelse(pcoa1$species %in% taxa_G3, "Cont",
                                    ifelse(pcoa1$species %in% taxa_common, "Common", "Common")))) %>%
  mutate(occurrence.color = ifelse(pcoa1$species %in% taxa_G1, "#6699FF",
                                   ifelse(pcoa1$species %in% taxa_G3, "#FF6666",
                                          ifelse(pcoa1$species %in% taxa_common, "#404040", "#404040")))) %>%
  mutate(id = "cluster") %>%
  mutate(Si.75perc.color = ifelse(pcoa1$species %in% taxa.Si.G1, "#6699FF", 
                                  ifelse(pcoa1$species %in% taxa.Si.G3, "#FF6666", 
                                         ifelse(pcoa1$species %in% taxa.Si.common, "#404040", "#CCCCCC")))) %>%
  mutate(Si.75perc.pch = ifelse(pcoa1$species %in% taxa.Si.G1, 17, 
                                ifelse(pcoa1$species %in% taxa.Si.G3, 17, 
                                       ifelse(pcoa1$species %in% taxa.Si.common, 17, 19)))) 
pcoa1 <- pcoa1 %>%
  mutate(Si.75perc.occurrence = ifelse(pcoa1$Si.75perc.color == "#6699FF", "UnCont1", 
                                       ifelse(pcoa1$Si.75perc.color == "#FF6666", "Cont", 
                                              ifelse(pcoa1$Si.75perc.color == "#404040", "Common", "Rare")))) %>%
  select(species, clust, clust.color, occurrence, occurrence.color, Si.75perc.color, Si.75perc.pch, Si.75perc.occurrence, id, Axis.1, Axis.2)
pcoa1$clust <- factor(pcoa1$clust, levels = c("FG1", "FG2", "FG3", "FG4", "FG5", "FG6", "FG7", "FG8", "FG9", "FG10"))
pcoa1$clust.color <- factor(pcoa1$clust.color, levels = unique(pcoa1$clust.color)[c(10, 9, 8, 3, 1, 4, 7, 5, 6, 2)])
pcoa1$occurrence <- factor(pcoa1$occurrence, levels = unique(pcoa1$occurrence)[c(2, 1, 3)])
pcoa1$occurrence.color <- factor(pcoa1$occurrence.color, levels = unique(pcoa1$occurrence.color)[c(2, 1, 3)])
pcoa1$Si.75perc.color <- factor(pcoa1$Si.75perc.color, levels = unique(pcoa1$Si.75perc.color)[c(2, 1, 3, 4)])
pcoa1$Si.75perc.occurrence <- factor(pcoa1$Si.75perc.occurrence, levels = unique(pcoa1$Si.75perc.occurrence)[c(2, 1, 3, 4)])

# Estimation of the convex hull for each functional group according to the first two axis of PCoA
hull_hc <- pcoa1 %>%
  group_by(clust) %>%
  slice(chull(Axis.1, Axis.2))

# Plot of the PCoA with convex hulles
gplot.pcoa <- ggplot(pcoa1, aes(x = Axis.1, y = Axis.2)) +
  geom_point(shape = 19, size = 2, col = pcoa1$Si.75perc.color)
gplot.pcoa <- gplot.pcoa + aes(fill = factor(clust)) + 
  geom_polygon(data = hull_hc, alpha = 0.5) +
  scale_fill_manual(values = as.character(unique(pcoa1$clust.color)[c(10, 9, 8, 3, 1, 4, 7, 5, 6, 2)])) +
  geom_point(shape = 19, size = 2, col = pcoa1$Si.75perc.color) +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        legend.position = "none",
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12)) +
  ylim(-7.5, 5) +
  labs(x = "PCoA axis 1", y = "PCoA axis 2") +
  geom_text(x = 1.5, y = -4.5, label = "FG2", size = 4) +
  geom_segment(aes(x = 1.2, xend = 0.9, y = -4.5, yend = -4.8), colour = "black", linetype = "solid")

# Legend of the UnCont1, Cont, Common, and Rare species
legend_occurrence_plot <- ggplot(pcoa1, aes(x = Axis.1, y = Axis.2, color = Si.75perc.occurrence)) +
  geom_point(size = 2) + 
  scale_color_manual(values = levels(pcoa1$Si.75perc.color)) +
  theme_bw() +
  theme_void() +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(size = 12))
legendoccurrence <- plot_grid(get_legend(legend_occurrence_plot + theme(legend.position = "left")))

# Legend of functional groups determined by cluster analysis
legend_FG <- data.frame(site = levels(pcoa1$clust), value = "cluster", group = levels(pcoa1$clust.color))
legend_FG$site <- factor(legend_FG$site, levels = unique(legend_FG$site))
legend_FG_plot <- ggplot(legend_FG, aes(value, group, fill = factor(site))) +
  geom_tile(alpha = 0.7) +
  theme_void() +
  theme(legend.title = element_blank(),
        legend.text = element_text(size = 12)) +
  scale_fill_manual(values = as.character(legend_FG$group), name = "Occurrence")  
legendFG <- plot_grid(get_legend(legend_FG_plot + theme(legend.position = "left")))

# Build Fig.2
Fig2 <- gplot.pcoa +
  annotation_custom(grob = ggplotGrob(legendoccurrence), xmin = -4, ymin = -7.65, xmax = -5.4, ymax = -5.2) +
  annotation_custom(grob = ggplotGrob(legendFG), xmin = -6.5, ymin = -7, xmax = -6.8, ymax = -2.8)

# Save as tiff file Fig.2 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_Fig2.tiff"),
     units = "in", width = 10, height = 8, res = 300)
print(Fig2)
dev.off()
```
![Figure 2](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_Fig2.png)

## Figure S1
```{r, eval = FALSE}
sac1 <- specaccum(TDFD_IBC_data$abundance[ ,-c(1:8)], method = "exact", gamma = "jack1")
sac2 <- specaccum(TDFD_IBC_data$abundance[ ,-c(1:8)], method = "random", gama = "jack1", permutations = 9999)

# Save as tiff file Fig.S1 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS1.tiff"),
     units = "in", width = 10, height = 8, res = 300)
plot(sac2, ci.type = "poly", lwd = 2, ci.lty = 0, ci.col = "lightgray", ylab = "Species", las = 1)
boxplot(sac2, col = "yellow", add = TRUE)
dev.off()
```
![Figure S1](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS1.png)

## Figure S2
```{r, eval = FALSE}
pcoa2 <- as.data.frame(pcoa0$vectors)
pcoa2.G1 <- pcoa2[rownames(pcoa2) %in% unique(abun_ibc.tidy$taxa[abun_ibc.tidy$group == "UnCont1"]), c(1, 2)]
pcoa2.G1$group.site <- "UnCont1"
pcoa2.G1$species <- rownames(pcoa2.G1)
pcoa2.G2 <- pcoa2[rownames(pcoa2) %in% unique(abun_ibc.tidy$taxa[abun_ibc.tidy$group == "UnCont2"]), c(1, 2)]
pcoa2.G2$group.site <- "UnCont2"
pcoa2.G2$species <- rownames(pcoa2.G2)
pcoa2.G3 <- pcoa2[rownames(pcoa2) %in% unique(abun_ibc.tidy$taxa[abun_ibc.tidy$group == "Cont"]), c(1, 2)]
pcoa2.G3$group.site <- "Cont"
pcoa2.G3$species <- rownames(pcoa2.G3)
pcoa2.G1G2G3 <- bind_rows(pcoa2.G1, pcoa2.G2, pcoa2.G3) 
pcoa2.G1G2G3 <- pcoa2.G1G2G3 %>%
  mutate(clust.color = ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 1]), "#4DAC26",
                              ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 2]), "#BB9D00",
                                     ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 3]), "#FDB863",
                                            ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 4]), "#D01C8B",
                                                   ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 5]), "#B8E186",
                                                          ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 6]), "#BF812D",
                                                                 ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 7]), "#F1B6DA",
                                                                        ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 8]), "#BABABA",
                                                                               ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 9]), "#404040",
                                                                                      ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 10]), "#FDE725FF", NA))))))))))) %>%
  mutate(clust = ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 1]), "FG1",
                        ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 2]), "FG2",
                               ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 3]), "FG3",
                                      ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 4]), "FG4",
                                             ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 5]), "FG5",
                                                    ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 6]), "FG6",
                                                           ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 7]), "FG7",
                                                                  ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 8]), "FG8",
                                                                         ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 9]), "FG9",
                                                                                ifelse(pcoa2.G1G2G3$species %in% names(fac[fac == 10]), "FG10", NA))))))))))) %>%
  mutate(occurrence = ifelse(pcoa2.G1G2G3$species %in% taxa_G1, "#6699FF",
                             ifelse(pcoa2.G1G2G3$species %in% taxa_G3, "#FF6666",
                                    ifelse(pcoa2.G1G2G3$species %in% taxa_common, "#404040", NA)))) %>%
  mutate(group.color = ifelse(pcoa2.G1G2G3$group.site == "UnCont1", "#6699FF",
                              ifelse(pcoa2.G1G2G3$group.site == "UnCont2", "#00BA42",
                                     ifelse(pcoa2.G1G2G3$group.site == "Cont", "#FF6666", NA)))) %>%
  mutate(id = "cluster") %>%
select(species, group.site, group.color, clust.color, clust, occurrence, id, Axis.1, Axis.2)
pcoa2.G1G2G3$clust <- factor(pcoa2.G1G2G3$clust, levels = c("FG1", "FG2", "FG3", "FG4", "FG5", "FG6", "FG7", "FG8", "FG9", "FG10"))
pcoa2.G1G2G3$group.site <- factor(pcoa2.G1G2G3$group.site, levels = c("UnCont1", "UnCont2", "Cont"))

# Plot of PCoA with four panels
# Panel A: PCoA of UnCont1
# Panel B: PCoA of UnCont2
# Panel C: PCoA of Cont
# Panel D: PCoA of UnCont1, UnCont2, Cont
# Estimation of the convex hull for each functional group for group of sites (i.e., UnCont1, UntCont2, Cont)
hull_group <- pcoa2.G1G2G3 %>%
  group_by(group.site) %>%
  slice(chull(Axis.1, Axis.2))

# Plot for UnCont1
my_text1 <- "UnCont1"
my_grob1 <- grid.text(my_text1, x = 0.09, y = 0.05, gp = gpar(col = "black", fontsize = 10))
gplot1 <- ggplot(pcoa2.G1G2G3[pcoa2.G1G2G3$group.site == "UnCont1", ], aes(x = Axis.1, y = Axis.2)) +
  geom_point(size = 2)
gplot1 <- gplot1 + aes(fill = factor(group.site)) + 
  geom_polygon(data = hull_group[hull_group$group.site == "UnCont1", ], alpha = 0.5) +
  scale_fill_manual(values = "#6699FF") +
  geom_point(shape = 19, size = 2, col = "black") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(),
        legend.position = "none") +
  labs(x = "PCoA axis 1", y = "PCoA axis 2", tag = "A") +
  xlim(-7.2, 5) +
  ylim(-5, 4) +
  annotation_custom(my_grob1)

# Plot for UnCont2
my_text2 <- "UnCont2"
my_grob2 <- grid.text(my_text2, x = 0.09, y = 0.05, gp = gpar(col = "black", fontsize = 10))
gplot2 <- ggplot(pcoa2.G1G2G3[pcoa2.G1G2G3$group.site == "UnCont2", ], aes(x = Axis.1, y = Axis.2)) +
  geom_point(size = 2)
gplot2 <- gplot2 + aes(fill = factor(group.site)) + 
  geom_polygon(data = hull_group[hull_group$group.site == "UnCont2", ], alpha = 0.5) +
  scale_fill_manual(values = "#00BA42") +
  geom_point(shape = 19, size = 2, col = "black") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(),
        legend.position = "none") +
  labs(x = "PCoA axis 1", y = "PCoA axis 2", tag = "B") +
  xlim(-7.2, 5) +
  annotation_custom(my_grob2)

# Plot for Cont
my_text3 <- "Cont"
my_grob3 <- grid.text(my_text3, x = 0.06, y = 0.05, gp = gpar(col = "black", fontsize = 10))
gplot3 <- ggplot(pcoa2.G1G2G3[pcoa2.G1G2G3$group.site == "Cont", ], aes(x = Axis.1, y = Axis.2)) +
  geom_point(size = 2)
gplot3 <- gplot3 + aes(fill = factor(group.site)) + 
  geom_polygon(data = hull_group[hull_group$group.site == "Cont", ], alpha = 0.5) +
  scale_fill_manual(values = "#FF6666") +
  geom_point(shape = 19, size = 2, col = "black") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(),
        legend.position = "none") +
  labs(x = "PCoA axis 1", y = "PCoA axis 2", tag = "C") +
  xlim(-7.2, 5) +
  annotation_custom(my_grob3)

# Plot for UnCont1-UnCont2-Cont
my_textall <- "UnCont1 vs. UnCont2 vs. Cont"
my_groball <- grid.text(my_textall, x = 0.255, y = 0.05, gp = gpar(col = "black", fontsize = 10))
gplotall <- ggplot(pcoa2.G1G2G3, aes(x = Axis.1, y = Axis.2)) +
  geom_point(size = 2)
gplotall <- gplotall + aes(fill = factor(group.site)) + 
  geom_polygon(data = hull_group, alpha = 0.3) +
  scale_fill_manual(values = c("#6699FF", "#00BA42", "#FF6666")) +
  geom_point(shape = 19, size = 2, col = "black") +
  theme_bw() +
  theme(panel.grid.minor = element_blank(),
        legend.title = element_blank(),
        legend.position = "none") +
  labs(x = "PCoA axis 1", y = "PCoA axis 2", tag = "D") +
  xlim(-7.2, 5) +
  annotation_custom(my_groball)

# Let's glue the different plots together to build Fig.S2
design <- c(
  area(1, 1, 1),
  area(2, 1, 2),
  area(1, 2, 1),
  area(2, 2, 2)
)
plot(design)

FigS2 <- gplot1 + gplot3 + gplot2 + gplotall +
  plot_layout(design = design, widths = c(1, 1, 1, 1), heights = c(1, 1, 1, 1))

# Save as tiff file Fig.S2 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS2.tiff"),
     units = "in", width = 10, height = 8, res = 300)
print(FigS2)
dev.off()
```
![Figure S2](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS2.png)

## Figure S3
| <span> |
| :------------------------------------------------------------------------------------------------------------ |
| **NOTE:** This part is based on the scarcity table calculated at the section 10 'Computation of scarcity at local scale' of this tutorial |
| <span> |
```{r, eval = FALSE}
# Add occurrence color to scarcity table of UnCont1 and Cont
Si.G1 <- Si.G1 %>%
  mutate(occurrence.color = ifelse(Si.G1$species %in% taxa.Si.G1, "#6699FF",
                                   ifelse(Si.G1$species %in% taxa.Si.common, "#404040", "#CCCCCC")))
Si.G3 <- Si.G3 %>%
  mutate(occurrence.color = ifelse(Si.G3$species %in% taxa.Si.G3, "#FF6666",
                                   ifelse(Si.G3$species %in% taxa.Si.common, "#404040", "#CCCCCC")))

# Add stars of taxa names
Si.G3$new.names.species <- as.character(Si.G3$species)
Si.G3$new.names.species[Si.G3$new.names.species == "Hydroptila"] <- paste0("**", Si.G3$new.names.species[Si.G3$new.names.species == "Hydroptila"])
Si.G3$new.names.species[Si.G3$new.names.species == "Micronecta"] <- paste0("*", Si.G3$new.names.species[Si.G3$new.names.species == "Micronecta"])
Si.G3$new.names.species[Si.G3$new.names.species == "Onychogomphus"] <- paste0("**", Si.G3$new.names.species[Si.G3$new.names.species == "Onychogomphus"])
Si.G3$new.names.species[Si.G3$new.names.species == "Oecetis"] <- paste0("**", Si.G3$new.names.species[Si.G3$new.names.species == "Oecetis"])
Si.G3$new.names.species[Si.G3$new.names.species == "Psychomyia"] <- paste0("*", Si.G3$new.names.species[Si.G3$new.names.species == "Psychomyia"])
Si.G3$new.names.species[Si.G3$new.names.species == "Stenelmis"] <- paste0("**", Si.G3$new.names.species[Si.G3$new.names.species == "Stenelmis"])
Si.G3$new.names.species[Si.G3$new.names.species == "Protonemura"] <- paste0("*", Si.G3$new.names.species[Si.G3$new.names.species == "Protonemura"])
Si.G3$new.names.species[Si.G3$new.names.species == "Ecnomus"] <- paste0("*", Si.G3$new.names.species[Si.G3$new.names.species == "Ecnomus"])
Si.G3$new.names.species[Si.G3$new.names.species == "Empididae"] <- paste0("**", Si.G3$new.names.species[Si.G3$new.names.species == "Empididae"])
Si.G3$new.names.species[Si.G3$new.names.species == "Goera"] <- paste0("*", Si.G3$new.names.species[Si.G3$new.names.species == "Goera"])
Si.G3$new.names.species[Si.G3$new.names.species == "Physella"] <- paste0("*", Si.G3$new.names.species[Si.G3$new.names.species == "Physella"])
Si.G3$new.names.species[Si.G3$new.names.species == "Leptophlebiidae"] <- paste0("*", Si.G3$new.names.species[Si.G3$new.names.species == "Leptophlebiidae"])
Si.G3$new.names.species[Si.G3$new.names.species == "Tabanidae"] <- paste0("**", Si.G3$new.names.species[Si.G3$new.names.species == "Tabanidae"])
Si.G3$new.names.species <- as.factor(Si.G3$new.names.species)
Si.G3$new.names.species <- factor(Si.G3$new.names.species, levels = Si.G3$new.names.species)

Si.G1$Si.G3 <- -0.1
for (i in 1:nrow(Si.G1)) {
  for (j in 1:nrow(Si.G3.75perc)) {
    if(Si.G1$species[i] %in% Si.G3.75perc$species[j]) {
      Si.G1$Si.G3[i] <- Si.G3.75perc$Si[j]
    }
  }
}
Si.G1$new.names.species <- as.character(Si.G1$species)
Si.G1$new.names.species[Si.G1$new.names.species == "Theodoxus"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Theodoxus"])
Si.G1$new.names.species[Si.G1$new.names.species == "Habroleptoides"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Habroleptoides"])
Si.G1$new.names.species[Si.G1$new.names.species == "Habrophlebia"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Habrophlebia"])
Si.G1$new.names.species[Si.G1$new.names.species == "Riolus"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Riolus"])
Si.G1$new.names.species[Si.G1$new.names.species == "Sisyra"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Sisyra"])
Si.G1$new.names.species[Si.G1$new.names.species == "Sericostoma"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Sericostoma"])
Si.G1$new.names.species[Si.G1$new.names.species == "Aphelocheirus"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Aphelocheirus"])
Si.G1$new.names.species[Si.G1$new.names.species == "Ecdyonurus"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Ecdyonurus"])
Si.G1$new.names.species[Si.G1$new.names.species == "Polycentropus"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Polycentropus"])
Si.G1$new.names.species[Si.G1$new.names.species == "Silo"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Silo"])
Si.G1$new.names.species[Si.G1$new.names.species == "Bithynia"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Bithynia"])
Si.G1$new.names.species[Si.G1$new.names.species == "Lepidostoma"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Lepidostoma"])
Si.G1$new.names.species[Si.G1$new.names.species == "Normandia"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Normandia"])
Si.G1$new.names.species[Si.G1$new.names.species == "Orconectes"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Orconectes"])
Si.G1$new.names.species[Si.G1$new.names.species == "Limnephilinae"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Limnephilinae"])
Si.G1$new.names.species[Si.G1$new.names.species == "Euleuctra"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Euleuctra"])
Si.G1$new.names.species[Si.G1$new.names.species == "Rhyacophila"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Rhyacophila"])
Si.G1$new.names.species[Si.G1$new.names.species == "Limoniidae"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Limoniidae"])
Si.G1$new.names.species[Si.G1$new.names.species == "Perla"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Perla"])
Si.G1$new.names.species[Si.G1$new.names.species == "Odontocerum"] <- paste0("*", Si.G1$new.names.species[Si.G1$new.names.species == "Odontocerum"])
Si.G1$new.names.species[Si.G1$new.names.species == "Radix"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Radix"])
Si.G1$new.names.species[Si.G1$new.names.species == "Cheumatopsyche"] <- paste0("**", Si.G1$new.names.species[Si.G1$new.names.species == "Cheumatopsyche"])
Si.G1$new.names.species <- as.factor(Si.G1$new.names.species)
Si.G1$new.names.species <- factor(Si.G1$new.names.species, levels = Si.G1$new.names.species)
Si.G1 <- Si.G1 %>%
  mutate(Si.G3.color = ifelse(Si.G1$Si.G3 != 0, "#E69F00", "#FFFFFF")) %>%
  mutate(Si.G3.shape = ifelse(Si.G1$Si.G3 != 0, 17, 19)) %>%
  mutate(Si.G3.size = ifelse(Si.G1$Si.G3 !=0, 2, 0)) 

# Plot for UnCont1
scarcity.g1 <- ggplot(Si.G1, aes(x = Si, y = new.names.species)) + 
  geom_point() +
  geom_point(data = Si.G1, aes(x = Si.G3, y = new.names.species), color = as.character(Si.G1$Si.G3.color), size = Si.G1$Si.G3.size, shape = Si.G1$Si.G3.shape) +
  theme_bw() +
  theme(axis.text.y = element_text(color = Si.G1$occurrence.color, size = 7),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()) +
  labs(x = "1 - scarcity") +
  ylab("Species") +
  geom_hline(yintercept = 33.5, color = "#000000", linetype = "dashed", size = 1) + #40perc
  xlim(0, 1) +
  labs(tag = "A")

# Plot for Cont
scarcity.g3 <- ggplot(Si.G3, aes(x = Si, y = new.names.species)) + 
  geom_point() +
  theme_bw() +
  theme(axis.text.y = element_text(color = Si.G3$occurrence.color, size = 7), 
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()) +
  labs(x = "1 - scarcity") +
  ylab("Species") +
  geom_hline(yintercept = 28.5, color = "#000000", linetype = "dashed", size = 1) + #40perc
  xlim(0, 1) +
  labs(tag = "B")

design <- c(
  area(1, 1, 1),
  area(1, 2, 1)
)
plot(design)

# Build Fig.S3
FigS3 <- scarcity.g1 + scarcity.g3 +
  plot_layout(design = design, widths = c(1, 1), heights = c(1, 1))

# Save as tiff file Fig.S3 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS3.tiff"),
     units = "in", width = 10, height = 8, res = 300)
print(FigS3)
dev.off()
```
![Figure S3](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS3.png)

## Figure S4
```{r, eval = FALSE}
dend <- hc.pcoa %>%
  as.dendrogram() %>%
  set("leaves_pch", c(19)) %>% 
  set("leaves_cex", c(1)) %>%
  set("leaves_col", "#FFFFFF") %>%
  set("labels_colors", "#404040") %>%
  set("labels_cex", c(0.5)) %>%
  set("branches_lwd", c(0.5)) %>%
  set("branches_lty", c(1)) %>%
  raise.dendrogram(1)
gdend <- as.ggdend(dend, type = "rectangle")
gdend <- ggplot(gdend, horiz = TRUE) 
gdend <- gdend + geom_segment(aes(x = 1, xend = 97, y = 6.5, yend = 6.5), colour = "#E69F00", linetype = "dashed")
gdend <- gdend + ylim(max(get_branches_heights(dend)), -8)
FigS4 <- gdend +
  geom_segment(aes(x = 87.5, xend = 97, y = -4.5, yend = -4.5), colour = "#FDE725FF", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 92.25, y = -5.8, label = "FG1") +
  geom_segment(aes(x = 80.5, xend = 87, y = -4.5, yend = -4.5), colour = "#404040", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 83.75, y = -5.8, label = "FG2") +
  geom_segment(aes(x = 67.5, xend = 80, y = -4.5, yend = -4.5), colour = "#BABABA", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 73.75, y = -5.8, label = "FG3") +
  geom_segment(aes(x = 49.5, xend = 67, y = -4.5, yend = -4.5), colour = "#FDB863", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 58.25, y = -5.8, label = "FG4") +
  geom_segment(aes(x = 38.5, xend = 49, y = -4.5, yend = -4.5), colour = "#4DAC26", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 43.75, y = -5.8, label = "FG5") +
  geom_segment(aes(x = 26.5, xend = 38, y = -4.5, yend = -4.5), colour = "#D01C8B", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 32.25, y = -5.8, label = "FG6") +
  geom_segment(aes(x = 22.5, xend = 26, y = -4.5, yend = -4.5), colour = "#F1B6DA", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 24.25, y = -5.8, label = "FG7") +
  geom_segment(aes(x = 12.5, xend = 22, y = -4.5, yend = -4.5), colour = "#B8E186", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 17.25, y = -5.8, label = "FG8") +
  geom_segment(aes(x = 6.5, xend = 12, y = -4.5, yend = -4.5), colour = "#BF812D", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 8.75, y = -5.8, label = "FG9") +
  geom_segment(aes(x = 0, xend = 6, y = -4.5, yend = -4.5), colour = "#BB9D00", linetype = "solid", size = 3, alpha = 0.7) +
  annotate(geom = "text", x = 3, y = -5.8, label = "FG10")

# Save as tiff file Fig.S4 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS4.tiff"),
     units = "in", width = 10, height = 8, res = 300)
print(FigS4)
dev.off()
```
![Figure S4](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS4.png)

## Figure S5
```{r, eval = FALSE}
# MRPP analysis
mrpp1 <- mrpp(e.dist, fac)
summary(mrpp1)

# Save as tiff file Fig.S5 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS5.tiff"),
     units = "in", width = 10, height = 8, res = 300)
with(mrpp1, {
 fig.dist <- hist(boot.deltas, xlim = range(c(delta,boot.deltas)), main = "", xlab = "Delta", col = "blue")
  mtext("MRPP (observed vs expected delta)", line = 2)
  mtext("Obsered delta = 8.591, Expected delta = 10.7, p = < 0.0001", line = 1, cex = 0.8)
  abline(v = delta, lty = "dashed", col = "red"); 
  text(delta, 2*mean(fig.dist$counts), adj = -0.5,
       expression(bold(delta)), cex = 1.5 )  }
)
dev.off()
```
![Figure S5](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS5.png)

## Figure S6
```{r, eval = FALSE}
# Split table according each functional group of the cluster
g1 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 10]), ]
g2 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 9]), ]
g3 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 8]), ]
g4 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 3]), ]
g5 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 1]), ]
g6 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 4]), ]
g7 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 5]), ]
g8 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 7]), ]
g9 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 2]), ]
g10 <- trait_eltonian[rownames(trait_eltonian) %in% names(fac[fac == 6]), ]

# Compute mean profil of each trait modality in each functional group
mean.g1 <- apply(g1, 2, mean)
mean.g2 <- apply(g2, 2, mean)
mean.g3 <- apply(g3, 2, mean)
mean.g4 <- apply(g4, 2, mean)
mean.g5 <- apply(g5, 2, mean)
mean.g6 <- apply(g6, 2, mean)
mean.g7 <- apply(g7, 2, mean)
mean.g8 <- apply(g8, 2, mean)
mean.g9 <- apply(g9, 2, mean)
mean.g10 <- apply(g10, 2, mean)

# Rearrange rows into columns for each functional group
## Functional group 1
melt.mean.g1 <- reshape::melt(mean.g1)
melt.mean.g1$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g1$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g1$id.group <- "FG1"
melt.mean.g1$id.trait_f <- factor(melt.mean.g1$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

## Functional group 2
melt.mean.g2 <- reshape::melt(mean.g2)
melt.mean.g2$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g2$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g2$id.group <- "FG2"
melt.mean.g2$id.trait_f <- factor(melt.mean.g2$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

## Functional group 3
melt.mean.g3 <- reshape::melt(mean.g3)
melt.mean.g3$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g3$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g3$id.group <- "FG3"
melt.mean.g3$id.trait_f <- factor(melt.mean.g3$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

## Functional group 4
melt.mean.g4 <- reshape::melt(mean.g4)
melt.mean.g4$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g4$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g4$id.group <- "FG4"
melt.mean.g4$id.trait_f <- factor(melt.mean.g4$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

## Functional group 5
melt.mean.g5 <- reshape::melt(mean.g5)
melt.mean.g5$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g5$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g5$id.group <- "FG5"
melt.mean.g5$id.trait_f <- factor(melt.mean.g5$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

## Functional group 6
melt.mean.g6 <- reshape::melt(mean.g6)
melt.mean.g6$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g6$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g6$id.group <- "FG6"
melt.mean.g6$id.trait_f <- factor(melt.mean.g6$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

# Functional group 7
melt.mean.g7 <- reshape::melt(mean.g7)
melt.mean.g7$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g7$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g7$id.group <- "FG7"
melt.mean.g7$id.trait_f <- factor(melt.mean.g7$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

## Functional group 8
melt.mean.g8 <- reshape::melt(mean.g8)
melt.mean.g8$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g8$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))

melt.mean.g8$id.group <- "FG8"
melt.mean.g8$id.trait_f <- factor(melt.mean.g8$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

## Functional group 9
melt.mean.g9 <- reshape::melt(mean.g9)
melt.mean.g9$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g9$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g9$id.group <- "FG9"
melt.mean.g9$id.trait_f <- factor(melt.mean.g9$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

## Functional group 10
melt.mean.g10 <- reshape::melt(mean.g10)
melt.mean.g10$id.trait <- c(rep("1", 7), rep("2", 2), rep("3", 3), rep("4", 4), rep("5", 7), 
                           rep("6", 4), rep("7", 5), rep("8", 4), rep("9", 8), rep("10", 9), rep("11", 7))
melt.mean.g10$id.modality <- c(c(1:7), c(1:2), c(1:3), c(1:4),
                              c(1:7), c(1:4), c(1:5), c(1:4),
                              c(1:8), c(1:9), c(1:7))
melt.mean.g10$id.group <- "FG10"
melt.mean.g10$id.trait_f <- factor(melt.mean.g10$id.trait, levels = c(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11))

# Merge the 10 tables in only one table
table_tot <- rbind(melt.mean.g1, melt.mean.g2, melt.mean.g3, melt.mean.g4, melt.mean.g5,
                   melt.mean.g6, melt.mean.g7, melt.mean.g8, melt.mean.g9, melt.mean.g10)
table_tot$id.group <- factor(as.factor(table_tot$id.group), levels(as.factor(table_tot$id.group))[c(1, 3, 4, 5, 6, 7, 8, 9, 10, 2)])

# Barplot of the mean profil for each functional group
FigS6 <- ggplot(table_tot, aes(x = as.factor(id.modality), y = value)) +
  geom_bar(stat = "identity", width = 0.8) +
  facet_grid(id.group ~ id.trait_f, scales = "free_x", space = "free_x") +
  theme_bw() +
  theme(axis.title.y = element_text(angle = 0, vjust = 0.5),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #strip.background = element_blank(),
        panel.border = element_rect(color = "black", fill = NA)) +
  xlab("Trait modalities") +
  ylab("") +
  ylim(0, 1)

# Save as tiff file Fig.S6 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS6.tiff"),
     units = "in", width = 10, height = 8, res = 300)
print(FigS6)
dev.off()
```
![Figure S6](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS6.png)

## Figure S7
```{r, eval = FALSE}
# Preparing the table for run plot
table_percent <- data.frame(group = rep(c("UnCont1", "UnCont1", "Cont", "Cont"), 2), 
                            type = rep(c("specific", "common"), 4),
                            analysis = c(rep("contribution", 4), rep("originality", 4)),
                            values = c(round((contrib_mean_UnCont1 * 100) / (contrib_mean_common_UnCont1 + contrib_mean_UnCont1), digits = 1), 
                                       round((contrib_mean_common_UnCont1 * 100) / (contrib_mean_common_UnCont1 + contrib_mean_UnCont1), digits = 1),
                                       round((contrib_mean_Cont * 100) / (contrib_mean_common_Cont + contrib_mean_Cont), digits = 1),
                                       round((contrib_mean_common_Cont * 100) / (contrib_mean_common_Cont + contrib_mean_Cont), digits = 1),
                                       round((orig_mean_UnCont1 * 100) / (orig_mean_common_UnCont1 + orig_mean_UnCont1), digits = 1),
                                       round((orig_mean_common_UnCont1 * 100) / (orig_mean_common_UnCont1 + orig_mean_UnCont1), digits = 1),
                                       round((orig_mean_Cont * 100) / (orig_mean_common_Cont + orig_mean_Cont), digits = 1),
                                       round((orig_mean_common_Cont * 100) / (orig_mean_common_Cont + orig_mean_Cont), digits = 1)),
                            lab_ypos = c(95.35, 45.35, 94.95, 44.95, 75.6, 24.8, 70.2, 26.6))
table_percent$group <- factor(table_percent$group, levels = c("UnCont1", "Cont"))
table_percent$type <- factor(table_percent$type, levels = c("specific", "common"))

FigS7 <- ggplot(table_percent, aes(x = group, y = values)) +
  geom_col(aes(fill = type), width = 0.7) +
  geom_text(aes(y = lab_ypos, label = values, group = type), size = 5) +
  scale_fill_manual(values = c("grey80", "grey50")) +
  theme_bw() +
  theme(panel.grid.major = element_line(colour = "white"),
        panel.grid.minor = element_line(colour = "white"),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 12),
        axis.title.y = element_text(size = 12),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 12),
        strip.text.x = element_text(size = 12)) +
  labs(x = "", y = "percentages") +
  facet_grid(. ~ analysis)

# Save as tiff file Fig.S7 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS7.tiff"),
     units = "in", width = 10, height = 8, res = 300)
print(FigS7)
dev.off()
```
![Figure S7](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS7.png)

## Figure S8
```{r, eval = FALSE}
# Test the relationship betwwen Rao's index and metal gradient
table_FD <- FD.FRar$FD.metrics[!(FD.FRar$FD.metrics$group == "Intermed"), ]
table_FD$group <- factor(table_FD$group, levels(table_FD$group)[c(3, 4, 1)])

# Test homoscedaticity of variances (levene test)
# if p.value > 0.05 we have homoscedasticity and we can make classical anova [aov()]
# if p.value < 0.05 we have heteroscedasticity and we can make modified anova, i.e. Welch-anova [userfriendlyscience::oneway()]
leven.FD.FDis <- car::leveneTest(FD.FDis ~ as.factor(group), data = table_FD) # p.value = 0.2643, thus we can made classical anova

# Test the group effect on Rao's index
aov.FDis <- aov(table_FD$FD.FDis ~ table_FD$group)
summary(aov.FDis) # p.value = 0.705
aov.FDis.posthoc <- TukeyHSD(aov.FDis)
table_FD$posthoc.FDis <- "a"

# Save as tiff file Fig.S8 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS8.tiff"),
     units = "in", width = 10, height = 8, res = 300)
par(mar = c(5, 5, 3, 5))
plot(1, mean(FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "UnCont1"]),
     xlim = c(0.5, 3.5), ylim = c(0, (max(FD.FRar$FD.metrics$FD.FDis) + 2)),
     las = 1, xaxt = "n", ann = FALSE, pch = 17, col = "#000000", cex = 2)
axis(1, seq(0, 4, 1), labels = c("", "UnCont1", "UnCont2", "Cont", ""))
points(rep(1, length(FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "UnCont1"])), 
       FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "UnCont1"], 
       cex = 1, pch = 19, col = "#0066CC")
points(2, mean(FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "UnCont2"]),
       pch = 17, col = "#000000", cex = 2)
points(rep(2, length(FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "UnCont2"])), 
       FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "UnCont2"],
       cex = 1, pch = 19, col = "#00CC00")
points(3, mean(FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "Cont"]),
       pch = 17, col = "#000000", cex = 2)
points(rep(3, length(FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "Cont"])), 
       FD.FRar$FD.metrics$FD.FDis[FD.FRar$FD.metrics$group == "Cont"],
       cex = 1, pch = 19, col = "#FF0000")
mtext(text = expression("FDis"), side = 2, line = 3, cex = 1)
text(c(1:(nlevels(table_FD$group))) , 
     c(9.5, 9.5, 9.5),
     c(unique(table_FD$posthoc.FDis)), cex = 1.5)
dev.off()
```
![Figure S8](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS8.png)

## Figure S9
```{r, eval = FALSE}
# Linear model between Rao's index and FDis
lm1 <- lm(FD.FDis ~ RaoQ.CH.scale, data = TDFD_IBC_res$TDFD_metrics)
summary.aov(lm1)
summary(lm1)
coeff.lm1 <- coefficients(lm1)

# Save as tiff file Fig.S9 with a resolution of 300 ppi
pathFig <- "C:/Users/benjamin/Documents/TDFD_IBCmetals/Figures/analysis_trait_x_IBCmet" # CHANGE ME to where you want figure to be saved
tiff(paste0(pathFig, "/Rplot_trait_x_IBC_FigS9.tiff"),
     units = "in", width = 10, height = 8, res = 300)
par(mar = c(5, 5, 4, 2))
plot(TDFD_res$RaoQ.CH.scale, TDFD_res$FD.FDis, 
     pch = 19, xlab = "", ylab = "", 
     col = "black", cex = 1, cex.axis = 1)
lines(TDFD_res$RaoQ.CH.scale, lm1$fitted.values, col="red")
text(0.5, 5.2, labels = bquote(y == .(round(coeff.lm1[2], 1))~"*"~FD[Q]~"-"~.(abs(round(coeff.lm1[1], 2)))),
     adj = 0, cex = 1)
text(0.5, 4.95, labels = bquote(R^2 == .(round(summary(lm1)$adj.r.squared, digits = 2))), 
     adj = 0, cex = 1)
text(0.5, 4.65, labels = bquote(italic('p')~'=' ~.(summary(lm1)$coefficients[2, 4])), adj = 0, cex = 1)
mtext(text = expression("FD"[Q]), side = 1, line = 3, cex = 1)
mtext(text = expression("F"[Dis]), side = 2, line = 3, cex= 1)
dev.off()
```
![Figure S9](C:/Users/benjamin/Documents/Travail_BA/IRSTEA_AFB48/Traits_x_IBC/TDFD_IBCmetals/figures/Rplot_trait_x_IBC_FigS9.png)

# Version of packages used to build this document
```{r, eval = TRUE}
sessionInfo()
```
